name: immortalwrt24.10 x86-64 Builder

on:
  workflow_dispatch:
  repository_dispatch:
    types: [immortalwrt-update]

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_NAME: immortalwrt
  REPO_BRANCH: openwrt-24.10
  OpenWrt_VERSION: 24.10
  OpenWrt_ARCH: x86-64
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: immortalwrt/diy-part1-x86-64.sh
  DIY_P2_SH: immortalwrt/diy-part2-x86-64-router.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
        run: |
          echo "è­¦å‘Šâš "
          echo "è‹¥åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½ä¸è¶³ï¼ŒåŠ¡å¿…åŠæ—¶å–æ¶ˆï¼Œé‡æ–°è¿è¡Œï¼"
          echo "å·²çŸ¥ç¼–è¯‘æˆåŠŸCPUå‹å·ï¼š8370C,8171M"
          echo "å·²çŸ¥æ€§èƒ½ä¸è¶³CPUå‹å·ï¼š8272CL,E5ç³»åˆ—"
          echo "--------------------------CPUä¿¡æ¯--------------------------"
          echo "CPUç‰©ç†æ•°é‡:$(cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l)"
          echo -e "CPUæ ¸å¿ƒåŠç‰ˆæœ¬ä¿¡æ¯ï¼š$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
          echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
          echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯ï¼š"
          sudo lshw -short -C memory | grep GiB
          echo -e "\n"
          echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
          echo -e  "ç¡¬ç›˜æ•°é‡ï¼š$(ls /dev/sd* | grep -v [1-9] | wc -l) \n"
          echo "ç¡¬ç›˜è¯¦æƒ…ï¼š"
          df -Th

      - name: ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ (æ¸…ç†å‰)
        run: |
          echo "æ¸…ç†å‰ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          echo "============================================"
          df -hT
          echo "============================================"

      - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´ (ç¬¬ä¸€é˜¶æ®µ)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: æœ€å¤§åŒ–æ„å»ºç©ºé—´ (ç¬¬äºŒé˜¶æ®µ)
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 5120
          swap-size-mb: 1
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ (æ¸…ç†å)
        if: (!cancelled())
        run: |
          echo "æ¸…ç†åç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          echo "============================================"
          df -hT
          echo "============================================"

      - name: å‡†å¤‡å®Œæˆ
        uses: actions/checkout@main

      - name: å®‰è£…å‰å½»åº•æ¸…ç†
        run: |
          echo "å®‰è£…ä¾èµ–å‰å½»åº•æ¸…ç†æ ¹åˆ†åŒº..."
          # æ¸…ç†APTç¼“å­˜
          sudo apt-get clean
          sudo rm -rf /var/cache/apt/archives/* /var/lib/apt/lists/*
          # æ¸…ç†ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶å’Œæ—¥å¿—
          sudo rm -rf /tmp/* /var/tmp/* /var/log/* 2>/dev/null || true
          # æ¸…ç†æ›´å¤šç³»ç»Ÿæ–‡ä»¶
          sudo rm -rf /usr/share/doc/* /usr/share/man/* /usr/share/locale/* 2>/dev/null || true
          sudo rm -rf /usr/share/sounds/* /usr/share/pixmaps/* 2>/dev/null || true
          # æ¸…ç†å†…æ ¸æ¨¡å—å¤‡ä»½
          sudo rm -rf /lib/modules/*/kernel/sound/* 2>/dev/null || true
          sudo rm -rf /lib/modules/*/kernel/drivers/media/* 2>/dev/null || true
          echo "æ¸…ç†å®Œæˆï¼Œå½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          df -hT /

      - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo bash -c 'bash <(curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "${TZ}"
          echo "ä½¿ç”¨GitHub Actionså·¥ä½œç›®å½• (120GBç©ºé—´):"
          mkdir -p ${GITHUB_WORKSPACE}/workdir
          echo "å·¥ä½œç›®å½•åˆ›å»ºå®Œæˆï¼Œç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          df -hT ${GITHUB_WORKSPACE}

      - name: ä¸‹è½½å›ºä»¶æºç 
        working-directory: ${{ github.workspace }}/workdir
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          df -hT $PWD
          echo "å¼€å§‹ä¸‹è½½æºç ..."
          git clone -b ${REPO_BRANCH} --single-branch --depth 1 ${REPO_URL} openwrt
          ln -sf ${GITHUB_WORKSPACE}/workdir/openwrt ${GITHUB_WORKSPACE}/openwrt
          echo "æºç ä¸‹è½½å®Œæˆï¼Œç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          df -hT ${GITHUB_WORKSPACE}

      - name: åŠ è½½è‡ªå®šä¹‰feeds
        run: |
          [ -e ${FEEDS_CONF} ] && mv ${FEEDS_CONF} openwrt/feeds.conf.default
          chmod +x ${DIY_P1_SH}
          cd openwrt
          ${GITHUB_WORKSPACE}/${DIY_P1_SH}

      - name: æ›´æ–°å¹¶å®‰è£…feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          rm -rf feeds/smpackage/{base-files,dnsmasq,firewall*,fullconenat,libnftnl,nftables,ppp,opkg,ucl,upx,vsftpd*,miniupnpd-iptables,wireless-regdb}

      - name: åŠ è½½configæˆ–ç”Ÿæˆé»˜è®¤é…ç½®
        run: |
          cd openwrt
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE .config || make defconfig
      
      - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
        env:
          PPPOE_USERNAME: ${{ secrets.PPPOE_USERNAME }}
          PPPOE_PASSWORD: ${{ secrets.PPPOE_PASSWORD }}
        run: |
          chmod +x ${DIY_P2_SH}
          cd openwrt
          ${GITHUB_WORKSPACE}/${DIY_P2_SH}

      - name: æ¸…ç†ä¸å¿…è¦æ–‡ä»¶
        run: |
          echo "æ¸…ç†å‰ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          df -hT ${GITHUB_WORKSPACE}
          # æ¸…ç†ç³»ç»Ÿç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶
          sudo rm -rf /tmp/* /var/tmp/* /var/cache/* /var/log/* 2>/dev/null || true
          sudo apt-get clean
          sudo rm -rf /usr/share/doc/* /usr/share/man/* /usr/share/locale/* 2>/dev/null || true
          echo "æ¸…ç†åç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          df -hT ${GITHUB_WORKSPACE}

      - name: ä¸‹è½½è½¯ä»¶åŒ…
        id: package
        run: |
          cd openwrt
          make defconfig
          make download -j4
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          echo "ä¸‹è½½å®Œæˆï¼Œç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          df -hT ${GITHUB_WORKSPACE}

      - name: ç¼–è¯‘å‰æœ€åæ¸…ç†
        run: |
          echo "ç¼–è¯‘å‰æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          sudo journalctl --vacuum-time=1d 2>/dev/null || true
          echo "ç¼–è¯‘å‰ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
          df -hT ${GITHUB_WORKSPACE}
          df -hT /
          
      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd openwrt
          echo -e "$(($(nproc) + 1)) thread compile"
          make -j$(($(nproc) + 1)) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          echo "COMPILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
        if: (!cancelled())
        run: df -hT

      - name: åˆ—å‡ºå›ºä»¶æ–‡ä»¶
        if: steps.compile.outputs.status == 'success' && !cancelled()
        run: |
          cd openwrt/bin/targets/*/*
          echo -e "------------------------------- æ–‡ä»¶åˆ—è¡¨ -------------------------------"
          ls
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: æ•´ç†å›ºä»¶
        if: steps.compile.outputs.status == 'success' && !cancelled()
        run: |
          cp -rf openwrt/.config ${{ env.FIRMWARE }}/config
          cd ${{ env.FIRMWARE }}
          rm -rf packages
          rm -rf profiles.json
          rm -rf *.buildinfo
          rm -rf *.manifest
          rm -rf *kernel.bin
          rm -rf *squashfs-rootfs.img.gz
          mv immortalwrt-${{ env.OpenWrt_ARCH }}-generic-rootfs.tar.gz immortalwrt-${{ env.OpenWrt_VERSION }}-${{ env.OpenWrt_ARCH }}-generic-rootfs-${{ env.COMPILE_DATE }}.tar.gz
          mv immortalwrt-${{ env.OpenWrt_ARCH }}-generic-squashfs-combined-efi.img.gz immortalwrt-${{ env.OpenWrt_VERSION }}-${{ env.OpenWrt_ARCH }}-generic-squashfs-combined-efi-${{ env.COMPILE_DATE }}.img.gz
          echo -e "------------------------------- æ–‡ä»¶åˆ—è¡¨ -------------------------------"
          ls

      - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
        id: tag
        if: steps.compile.outputs.status == 'success' && !cancelled()
        run: |
          echo "release_tag=${{ env.REPO_NAME }}_${{ env.OpenWrt_VERSION }}_${{ env.OpenWrt_ARCH }}_${{ env.COMPILE_DATE }}" >> ${GITHUB_OUTPUT}
          touch ${{ env.REPO_NAME }}-${{ env.OpenWrt_ARCH }}-release.txt
          echo "
          ğŸ’» æ¶æ„: ${{ env.OpenWrt_ARCH }}

          ğŸ“‚ æºç : ${{ env.REPO_URL }}

          ğŸŒ³ åˆ†æ”¯: ${{ env.REPO_BRANCH }}

          â±ï¸ ç¼–è¯‘æ—¶é—´: ${{ env.COMPILE_DATE }}

          ğŸŒ ç®¡ç†åœ°å€: 192.168.5.1 , å­ç½‘æ©ç : 255.255.255.0

          ğŸ‘¤ ç”¨æˆ·å: root

          ğŸ”’ å¯†ç : password

          ğŸ“¡ ç½‘ç»œé…ç½®:
          - é»˜è®¤ä¸º DHCP æ¨¡å¼
          - æ”¯æŒ PPPoE æ‹¨å·é…ç½®
          - é…ç½®æ–‡ä»¶: /etc/uci-defaults/99-network-setup

          ğŸ” PPPoE è‡ªåŠ¨é…ç½®ï¼ˆæ¨èï¼‰:
          1. ä»“åº“ Settings â†’ Secrets and variables â†’ Actions
          2. æ·»åŠ  Secret: PPPOE_USERNAME (ä½ çš„PPPoEç”¨æˆ·å)
          3. æ·»åŠ  Secret: PPPOE_PASSWORD (ä½ çš„PPPoEå¯†ç )
          4. é‡æ–°è¿è¡Œ Actions ç¼–è¯‘ï¼Œå›ºä»¶å°†è‡ªåŠ¨é…ç½®PPPoE

          ğŸ”§ æ‰‹åŠ¨é…ç½®æ–¹æ³•:
          1. SSH è¿æ¥: ssh root@192.168.5.1
          2. é€šè¿‡ LuCI ç•Œé¢: ç½‘ç»œ â†’ æ¥å£ â†’ WAN â†’ ä¿®æ”¹
          3. åè®®æ”¹ä¸º PPPoEï¼Œå¡«å…¥ç”¨æˆ·åå¯†ç 
          4. ä¿å­˜å¹¶åº”ç”¨é…ç½®

          " > ${{ env.REPO_NAME }}-${{ env.OpenWrt_ARCH }}-release.txt
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: å‘å¸ƒå›ºä»¶åˆ° Releases
        uses: softprops/action-gh-release@v2
        if: steps.tag.outputs.status == 'success' && !cancelled()
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: ${{ env.REPO_NAME }}-${{ env.OpenWrt_ARCH }}-release.txt
          files: ${{ env.FIRMWARE }}/*

      - name: åˆ é™¤ Releases æ—§ç‰ˆæœ¬
        uses: dev-drprasad/delete-older-releases@master
        if: steps.tag.outputs.status == 'success' && !cancelled()
        with:
          keep_latest: 2
          delete_tags: true
          delete_tag_pattern: ^${{ env.REPO_NAME }}_${{ env.OpenWrt_VERSION }}_${{ env.OpenWrt_ARCH }}_.*$
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}